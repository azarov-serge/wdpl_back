# Оставшиеся шаги (по docs/SUPABASE.md)

Документ сверяет реализацию Go‑бэкенда с доменами и этапами из `docs/SUPABASE.md` и фиксирует, что ещё не покрыто шагами в `docs/steps`.

---

## Что уже покрыто (STEP1–STEP4)

| Шаг   | Домен / назначение                                 | Соответствие SUPABASE.md                     |
| ----- | -------------------------------------------------- | -------------------------------------------- |
| STEP1 | Авторизация (auth.users, refresh_tokens)           | Домен «1. Аутентификация и пользователи»     |
| STEP2 | Профили пользователей (user_profiles)              | Расширение пользователя (профиль)            |
| STEP3 | Черновики событий (event_drafts, event_day_drafts) | EventDraft, EventDayDraft, доступ редакторов |
| STEP4 | Публичные события (events, event_days), публикация | Event, EventDay, операция публикации         |

**Этапы SUPABASE**, которые для Go‑бэкенда уже учтены:

- **Этап 2 (структура БД)** — частично: есть миграции для auth, user_profiles, events, event_drafts, event_days, event_days_drafts.
- **Этап 3 (RLS)** — эквивалент на бэкенде: middleware `RequireAuth` и `RequireRole` для доступа к черновикам.

---

## Что в SUPABASE.md ещё не отражено в шагах

### Домены данных (раздел «Домены и модели данных»)

| Домен в SUPABASE.md        | Описание                                                                                                                                          | Статус в docs/steps |
| -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------- |
| **SessionType**            | Справочник типов сессий (break, coffee_break, lunch, intro, pitch и т.д.). Таблица `session_types`. Используется в JSONB `schedule` в event_days. | Не описан           |
| **4. Команды и участники** | Team, Person, TeamMember. Таблицы `teams`, `people`, `team_members`.                                                                              | Не описан           |
| **5. Материалы**           | Asset. Таблица `assets` (event_id, session_id, title, url, mime_type). Связь с хранилищем файлов.                                                 | Не описан           |

### Этапы «Пошаговой реализации» SUPABASE

| Этап в SUPABASE | Содержание                              | Применимость к Go‑бэкенду                                                     |
| --------------- | --------------------------------------- | ----------------------------------------------------------------------------- |
| **Этап 1**      | Настройка Supabase проекта, клиенты     | Не применим (у нас свой бэкенд)                                               |
| **Этап 2**      | Создание структуры БД                   | Частично: нет миграций для session_types, teams, people, team_members, assets |
| **Этап 3**      | RLS                                     | Реализовано через middleware (auth/role)                                      |
| **Этап 4**      | Реализация на клиентах (React, Flutter) | Не шаг бэкенда; контракты API уже заданы в STEP1–4                            |
| **Этап 5**      | Supabase Storage для файлов             | Для Go: нужен аналог — фича «файлы/материалы» + хранилище (S3 или локальное)  |
| **Этап 6**      | Тестирование (RLS, JSONB, real-time)    | Для Go: интеграционные/unit‑тесты; не оформлено в отдельном шаге              |

---

## Рекомендуемые следующие шаги (сохранить в docs/steps)

Ниже — кандидаты в следующие шаги; при реализации можно оформить их как STEP5.md, STEP6.md и т.д.

### STEP5: Типы сессий и команды/участники (по SUPABASE §3–4)

- **Цель:** справочник типов сессий и домен «Команды и участники».
- **Модели/таблицы:**
  - `session_types` (id, code, title, created_at, updated_at).
  - `teams` (id, event_id, title, …).
  - `people` (id, full_name, email, phone, org_role, …).
  - `team_members` (id, team_id, person_id, role_in_team, …).
- **Фичи:** либо отдельные `internal/features/sessiontypes` и `internal/features/teams`, либо одна фича «расписание/участники» — по вкусу архитектуры.
- **API:** CRUD по типам сессий; CRUD по командам и участникам (с привязкой к event_id где нужно). Контракты взять из SUPABASE.md.

### STEP6: Материалы (Assets) и хранилище файлов (по SUPABASE §5 и Этап 5)

- **Цель:** вложения/материалы (Asset) и загрузка файлов.
- **Модели/таблицы:**
  - `assets` (id, event_id, session_id, title, url, mime_type, …) — как в SUPABASE.md.
- **Инфраструктура:** выбор хранилища (S3-совместимое, локальный диск, и т.д.), политика доступа (кто может загружать/скачивать).
- **Фича:** `internal/features/assets` (или `materials`) — домен Asset, репозиторий, сервис, handler; эндпоинты вида GET/POST/DELETE для привязки к событию/сессии.
- **Связь с Этапом 5 SUPABASE:** в Supabase — Storage + RLS; в Go — свой endpoint загрузки и запись `url` в `assets`.

### Дополнительно (по желанию)

- **Метаданные event_days:** в SUPABASE.md описаны функции/триггеры для `session_count`, `first_session_start`, `last_session_end`. Для Go можно:
  - либо вычислять при публикации (в сервисе событий),
  - либо добавить миграцию с триггерами в БД и не дублировать логику в коде.
- **Отдельный шаг «Тестирование»:** вынести в docs/steps (например, STEP_TESTING.md) требования к тестам: unit‑тесты сервисов, интеграционные тесты API, проверка контрактов из STEP1–4.

---

## Сводная таблица: что осталось

| №   | Шаг (кандидат)      | Домен SUPABASE                            | Приоритет для MVP                |
| --- | ------------------- | ----------------------------------------- | -------------------------------- |
| 5   | SessionType + Teams | §3 SessionType, §4 Team/Person/TeamMember | Средний                          |
| 6   | Assets + файлы      | §5 Asset, Этап 5 Storage                  | Средний                          |
| —   | Триггеры event_days | §2.2 метаданные                           | Низкий (уже есть поля в таблице) |
| —   | Документ по тестам  | Этап 6                                    | По желанию                       |

Файлы STEP1.md – STEP4.md менять не требуется; при реализации следующих шагов добавить в `docs/steps` файлы STEP5.md, STEP6.md по образцу существующих.
